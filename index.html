<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SaaS M&A Tracker</title>
  <meta name="description" content="SaaS M&A tracker powered by Google Sheets CSV" />

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --text:#e7eef8;
      --muted:#9fb0c7;
      --line:#223043;
      --accent:#7dd3fc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{border-bottom:1px solid var(--line)}
    h1{margin:0 0 6px 0;font-size:24px}
    .sub{color:var(--muted);margin-bottom:14px}

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }
    input,select,button{
      background:var(--panel);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
    }
    input{flex:1;min-width:240px}
    button{cursor:pointer}

    .meta{color:var(--muted);font-size:13px;margin-bottom:12px}

    .table-wrap{
      overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:980px;
    }
    th,td{
      padding:12px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:14px;
      vertical-align:top;
    }
    th{
      color:var(--muted);
      cursor:pointer;
      white-space:nowrap;
    }
    tr:hover{background:rgba(125,211,252,0.06)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    .badge{
      display:inline-block;
      padding:2px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      margin-left:6px;
    }
    .tags{color:var(--muted);font-size:12px;margin-top:4px}
    .error{
      margin-top:14px;
      padding:12px;
      border:1px solid #7f1d1d;
      background:rgba(127,29,29,0.15);
      border-radius:12px;
      color:#fecaca;
      display:none;
    }
  </style>
</head>

<body>
<header class="wrap">
  <h1>SaaS M&A Tracker</h1>
  <div class="sub">Deals from 2022 → present. Live data from Google Sheets.</div>

  <div class="controls">
    <input id="q" placeholder="Search target, acquirer, ticker, description…" />
    <select id="year"><option value="">All years</option></select>
    <select id="type"><option value="">All types</option></select>
    <select id="status"><option value="">All statuses</option></select>
    <button id="reset">Reset</button>
  </div>

  <div class="meta">
    <span id="count">0 deals</span> · <span id="updated">Loading…</span>
  </div>

  <div id="err" class="error"></div>
</header>

<main class="wrap">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Target</th>
          <th>Acquirer</th>
          <th>Value</th>
          <th>Type</th>
          <th>Status</th>
          <th>Links</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</main>

<script>
/* ===== YOUR PUBLISHED CSV ===== */
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSAjnPyDXf1fzbGmPdgs7xKzhU_p3lg_hNJDWJsvBDgNYCjSRV2UFzqwEM7j8CZBQrnoFnJX53XSoWt/pub?output=csv";

let DEALS = [];
let sortColumn = null;
let sortAsc = true;
const $ = id => document.getElementById(id);

function fmtUSD(x){
  const n = Number(String(x||"").replace(/[^0-9.-]/g,""));
  if(!n) return "";
  if(n>=1e9) return `$${(n/1e9).toFixed(1)}B`;
  if(n>=1e6) return `$${(n/1e6).toFixed(1)}M`;
  return `$${n.toLocaleString()}`;
}

function parseCSV(text){
  const rows=[], row=[], out=[];
  let cur="", inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(inQ){
      if(c=='"' && text[i+1]=='"'){cur+='"';i++}
      else if(c=='"'){inQ=false}
      else cur+=c;
    } else {
      if(c=='"') inQ=true;
      else if(c==','){row.push(cur);cur=""}
      else if(c=='\n'){row.push(cur);rows.push(row.splice(0));cur=""}
      else if(c!='\r') cur+=c;
    }
  }
  if(cur||row.length){row.push(cur);rows.push(row)}
  return rows.filter(r=>r.some(x=>x.trim()!==""));
}

function isValidURL(str){
  if(!str || str.trim()==="") return false;
  try {
    const url = new URL(str);
    return url.protocol === "http:" || url.protocol === "https:";
  } catch {
    return false;
  }
}

function filterDeals(){
  const query = $("q").value.toLowerCase();
  const year = $("year").value;
  const type = $("type").value;
  const status = $("status").value;

  let filtered = DEALS.filter(d => {
    const searchMatch = !query ||
      d.target.toLowerCase().includes(query) ||
      d.acquirer.toLowerCase().includes(query) ||
      d.tags.join(" ").toLowerCase().includes(query) ||
      (d.notes||"").toLowerCase().includes(query);

    const yearMatch = !year || d.announceDate.startsWith(year);
    const typeMatch = !type || d.dealType === type;
    const statusMatch = !status || d.status === status;

    return searchMatch && yearMatch && typeMatch && statusMatch;
  });

  if(sortColumn !== null){
    filtered.sort((a,b) => {
      let valA, valB;
      switch(sortColumn){
        case 0: valA = a.announceDate; valB = b.announceDate; break;
        case 1: valA = a.target.toLowerCase(); valB = b.target.toLowerCase(); break;
        case 2: valA = a.acquirer.toLowerCase(); valB = b.acquirer.toLowerCase(); break;
        case 3:
          valA = Number(String(a.valueUSD||"0").replace(/[^0-9.-]/g,"")) || 0;
          valB = Number(String(b.valueUSD||"0").replace(/[^0-9.-]/g,"")) || 0;
          break;
        case 4: valA = a.dealType; valB = b.dealType; break;
        case 5: valA = a.status; valB = b.status; break;
        default: return 0;
      }
      if(valA < valB) return sortAsc ? -1 : 1;
      if(valA > valB) return sortAsc ? 1 : -1;
      return 0;
    });
  }

  render(filtered);
}

function render(list){
  $("rows").innerHTML = list.map(d=>`
    <tr>
      <td>${d.announceDate}</td>
      <td>
        <strong>${d.target}</strong>
        ${d.tags.length?`<div class="tags">${d.tags.join(" • ")}</div>`:""}
      </td>
      <td>${d.acquirer}${d.dealType?`<span class="badge">${d.dealType}</span>`:""}</td>
      <td>${fmtUSD(d.valueUSD)}</td>
      <td>${d.dealType}</td>
      <td>${d.status}</td>
      <td>
        ${isValidURL(d.pressLink)?`<a href="${d.pressLink}" target="_blank" rel="noopener">Press</a>`:""}
        ${isValidURL(d.secLink)?` · <a href="${d.secLink}" target="_blank" rel="noopener">SEC</a>`:""}
      </td>
    </tr>
  `).join("");
  $("count").textContent = `${list.length} deal${list.length===1?"":"s"}`;
}

function populateFilters(){
  const years = [...new Set(DEALS.map(d => d.announceDate.substring(0,4)))].sort().reverse();
  const types = [...new Set(DEALS.map(d => d.dealType).filter(Boolean))].sort();
  const statuses = [...new Set(DEALS.map(d => d.status).filter(Boolean))].sort();

  $("year").innerHTML = '<option value="">All years</option>' +
    years.map(y => `<option value="${y}">${y}</option>`).join("");

  $("type").innerHTML = '<option value="">All types</option>' +
    types.map(t => `<option value="${t}">${t}</option>`).join("");

  $("status").innerHTML = '<option value="">All statuses</option>' +
    statuses.map(s => `<option value="${s}">${s}</option>`).join("");
}

async function load(){
  const res = await fetch(CSV_URL,{cache:"no-store"});
  const csv = await res.text();
  const m = parseCSV(csv);
  const h = m[0];
  const rows = m.slice(1);

  const objects = rows.map(r=>{
    const o={}; h.forEach((k,i)=>o[k]=r[i]||""); return o;
  });

  DEALS = objects.map(r=>({
    announceDate: r.Date || "",
    target: r.Target || "",
    acquirer: r.Acquirer || "",
    valueUSD: r.Deal_Value || "",
    dealType: r.Acquirer_Type || "",
    status: r.Status || "",
    tags: (r.Ticker||"").split(",").map(x=>x.trim()).filter(Boolean),
    pressLink: r.Press_Release || "",
    secLink: r.Proxy || r.Other_Link || "",
    notes: r.Description || ""
  })).filter(d=>d.announceDate && d.announceDate>="2022-01-01");

  populateFilters();
  $("updated").textContent = `Updated ${new Date().toLocaleString()}`;
  render(DEALS);

  // Add event listeners
  $("q").addEventListener("input", filterDeals);
  $("year").addEventListener("change", filterDeals);
  $("type").addEventListener("change", filterDeals);
  $("status").addEventListener("change", filterDeals);

  $("reset").addEventListener("click", () => {
    $("q").value = "";
    $("year").value = "";
    $("type").value = "";
    $("status").value = "";
    sortColumn = null;
    filterDeals();
  });

  // Add sorting to table headers
  document.querySelectorAll("th").forEach((th, idx) => {
    if(idx < 6) {
      th.addEventListener("click", () => {
        if(sortColumn === idx){
          sortAsc = !sortAsc;
        } else {
          sortColumn = idx;
          sortAsc = true;
        }
        filterDeals();
      });
    }
  });
}

load().catch(e=>{
  $("err").style.display="block";
  $("err").textContent = `Error: ${e.message}`;
  console.error(e);
});
</script>
</body>
</html>
